<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <style>
      :root {
        --neon-blue: #00eaff;
        --neon-green: #00ffbf;
        --dark-bg: #000;
        --glass: rgba(255, 255, 255, 0.08);
      }

      /* ---------------- BODY ---------------- */
      body {
        font-family: "Poppins", sans-serif;
        background: var(--dark-bg);
        margin: 0;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-x: hidden;
        min-height: 100vh;
      }

      /* ---------------- HEADER ---------------- */
      header {
        position: sticky;
        top: 0;
        width: 100%;
        padding: 15px 5%;
        padding-left: 40px;
        padding-right: 60px;
        background: rgba(20, 20, 20, 0.45);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
      }

      .logo {
        padding-left: 40px;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--neon-blue);
        cursor: pointer;
      }

      /* ---------------- SEARCH BOX ---------------- */
      .do {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        width: 90%;
        max-width: 500px;
      }

      .do input {
        flex: 1;
        padding: 13px 20px;
        background: #111;
        border: 1px solid var(--neon-blue);
        border-right: none;
        border-radius: 10px 0 0 10px;
        color: #fff;
      }

      .do button {
        padding: 13px 20px;
        background: var(--neon-green);
        border-radius: 0 10px 10px 0;
        font-weight: 600;
        cursor: pointer;
      }

      /* ---------------- CART ITEM ROW LAYOUT ---------------- */
      .child {
        width: 95%;
        max-width: 950px;
        padding: 15px;
        margin: 15px 0;
        background: var(--glass);
        border-radius: 12px;
        border: 1px solid rgba(0, 255, 191, 0.3);
        backdrop-filter: blur(12px);

        display: grid;
        grid-template-columns: 80px 1fr auto auto;
        align-items: center;
        gap: 20px;
      }

      /* IMAGE */
      .child img {
        width: 80px;
        height: 95px;
        border-radius: 8px;
        object-fit: cover;
      }

      /* NAME + PRICE SECTION */
      .info h3 {
        margin: 0;
        font-size: 18px;
        color: var(--neon-blue);
      }

      .price {
        font-size: 16px;
        font-weight: 600;
        color: var(--neon-green);
      }

      /* QTY CONTROLS */
      .qty-box {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .qty-btn,
      button {
        padding: 6px 12px;
        font-size: 16px;
        background: var(--neon-green);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .qty {
        padding: 6px 12px;
        background: var(--neon-blue);
        border-radius: 50%;
        font-weight: bold;
        color: #000;
        animation: neonPulse 1.5s infinite;
      }

      @keyframes neonPulse {
        0%,
        100% {
          box-shadow: 0 0 6px var(--neon-blue);
        }
        50% {
          box-shadow: 0 0 12px var(--neon-green);
        }
      }

      /* DELETE BUTTON */
      .child .delete-btn {
        padding: 12px;
        background: red;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
      }

      /* ---------------- BILL ---------------- */
      .bill {
        padding: 15px 25px;
        background: var(--glass);
        border-radius: 10px;
        font-weight: 700;
        font-size: 20px;
        margin-top: 20px;
      }

      /* ---------------- PAYMENT BOX ---------------- */
      .payment-container {
        width: 250px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 30px auto;
      }

      .payment-select select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--neon-blue);
        border-radius: 8px;
        background: #1a1a1a;
        color: white;
      }

      .confirm-btn {
        padding: 12px;
        background: #434bff;
        color: white;
        border-radius: 8px;
        font-weight: 600;
      }

      /* =====================================================
   RESPONSIVE FIXES
===================================================== */

      /* TABLETS */
      @media (max-width: 768px) {
        .child {
          grid-template-columns: 120px 1fr;
          grid-template-rows: auto auto auto;
          text-align: center;
          gap: 10px;
        }

        .qty-box {
          justify-content: center;
        }

        .child .delete-btn {
          grid-column: span 2;
          width: 100%;
        }

        .child img {
          margin: 0 auto;
        }
      }

      /* MOBILE */
      @media (max-width: 480px) {
        .child {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .child img {
          width: 120px;
          height: 150px;
          margin: 0 auto;
        }

        .qty-box {
          justify-content: center;
        }

        .child .delete-btn {
          width: 100%;
        }

        .info h3 {
          font-size: 16px;
        }
        .price {
          font-size: 14px;
        }
      }

      /* ULTRA SMALL */
      @media (max-width: 340px) {
        .qty,
        .qty-btn {
          font-size: 14px;
        }
      }
    </style>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <header>
      <div class="logo" onclick="window.location.href='index.html'">
        Book-It
      </div>
      <button class="clear" onclick="clearall()">
        Clear All <i class="fa-solid fa-trash-can"></i>
      </button>
      <!-- <div></div> -->
    </header>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDqL0PxVEwZw0EjCXRr-4GoeVXBYUbLKzM",
        authDomain: "book-it-31803.firebaseapp.com",
        projectId: "book-it-31803",
        storageBucket: "book-it-31803.firebasestorage.app",
        messagingSenderId: "811736774940",
        appId: "1:811736774940:web:17b328d65d808f8492a2d9",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          // User NOT logged in
          alert("You must be logged in to access this page.");
          window.location.href = "login.html";
        }
      });
    </script>

    <script>
      // ---------------------- CART LOGIC ----------------------
      let data = JSON.parse(localStorage.getItem("cartItems")) || [];
      console.log(data);

      let tosum = 0; // total bill amount
      let tc = 0; // total quantity

      const productsContainer = document.createElement("div");
      productsContainer.classList.add("products");
      document.body.append(productsContainer);

      // ---------------------- LOOP THROUGH PRODUCTS ----------------------
      data.forEach((val) => {
        let card = document.createElement("div");
        card.classList.add("child");

        let img = document.createElement("img");
        let info = document.createElement("div"); // NEW
        let controls = document.createElement("div"); // NEW

        let h3 = document.createElement("h3");
        let p = document.createElement("p");
        let q = document.createElement("p");

        let add = document.createElement("button");
        let remove = document.createElement("button");
        let dlt = document.createElement("button");

        let total = document.createElement("div");

        // CLASSES
        total.classList.add("total");
        p.classList.add("price");
        q.classList.add("qty");
        info.classList.add("info");
        controls.classList.add("qty-box");

        // BUTTON TEXT
        add.innerText = "+";
        remove.innerText = "-";
        dlt.innerHTML = '<i class="fa-solid fa-trash-can"></i>';

        dlt.style.backgroundColor = "red";
        dlt.style.color = "white";

        // ---------------------- PRICE CALCULATION ----------------------
        let sum = val.price * val.qty;
        total.innerText = "â‚¹" + sum;

        tosum += sum;
        tc += val.qty;
        // ---------------------- BUTTON ACTIONS ----------------------
        add.onclick = function () {
          val.qty += 1;
          localStorage.setItem("cartItems", JSON.stringify(data));
          window.location.reload();
        };

        remove.onclick = function () {
          if (val.qty > 1) {
            val.qty -= 1;
            localStorage.setItem("cartItems", JSON.stringify(data));
            window.location.reload();
          } else {
            data = data.filter((item) => item.name !== val.name);
            localStorage.setItem("cartItems", JSON.stringify(data));
            window.location.reload();
          }
        };

        dlt.onclick = function () {
          data = data.filter((item) => item.name !== val.name);
          localStorage.setItem("cartItems", JSON.stringify(data));
          window.location.reload();
        };

        img.src = val.image;
        h3.innerText = val.name;
        p.innerText = `â‚¹${val.price}`;
        q.innerText = val.qty;

        // ---------------------- BUILD STRUCTURE ----------------------
        controls.appendChild(remove);
        controls.appendChild(q);
        controls.appendChild(add);

        info.appendChild(h3);
        info.appendChild(p);

        card.appendChild(img);
        card.appendChild(info);
        card.appendChild(controls);
        card.appendChild(dlt);
        productsContainer.append(card);
      });

      // ---------------------- TOTAL QUANTITY ----------------------
      localStorage.setItem("tc", tc);

      // ---------------------- BILL ----------------------
      let bill = document.createElement("div");
      bill.classList.add("bill");
      updateBillUI();
      document.body.append(bill);

      function updateBillUI() {
        if (data.length === 0) {
          bill.innerText = "Cart is empty, Add Products";
          bill.style.background = "transparent";
          bill.style.fontSize = "2.5rem";
        } else {
          let discounted = localStorage.getItem("discountedTotal");
          if (discounted) {
            bill.innerHTML = `Total Bill After Offer: â‚¹${discounted}`;
          } else {
            bill.innerHTML = `Total Bill: â‚¹${tosum}`;
          }
        }
      }

      // ---------------------- CLEAR ALL ----------------------
      function clearall() {
        localStorage.removeItem("cartItems");
        localStorage.setItem("tc", 0);
        localStorage.removeItem("discountedTotal");
        window.location.reload();
      }

      // ---------------------- OFFER LOGIC ----------------------
      let offers = [45, 20, 10, 30, 50];
      let currentOffer = null;
      let offerTimer = null;

      const notification = document.createElement("div");
      notification.classList.add("notification");
      notification.style.display = "none";
      notification.innerHTML = `
  <span id="offerText"></span>
  <button id="claimBtn">Claim</button>
`;
      document.body.append(notification);

      function showOffer() {
        let lastClaim = localStorage.getItem("offerClaimTime");

        // â›” Offer claimed within last 30 mins â†’ Do NOT show new offer
        if (lastClaim && Date.now() - lastClaim < 30 * 60 * 1000) {
          notification.style.display = "block";
          document.getElementById("offerText").innerText =
            "âš ï¸ Offer already claimed. Try again later.";
          document.getElementById("claimBtn").style.display = "none";
          return;
        }

        // ðŸŸ¢ Show new offer
        currentOffer = offers[Math.floor(Math.random() * offers.length)];
        document.getElementById(
          "offerText"
        ).innerText = `ðŸŽ‰ You got ${currentOffer}% OFF! (Valid for 2 min)`;
        document.getElementById("claimBtn").style.display = "inline-block";
        notification.style.display = "block";

        if (offerTimer) clearTimeout(offerTimer);

        offerTimer = setTimeout(() => {
          notification.style.display = "none";
          currentOffer = null;
        }, 2 * 60 * 1000); // 2 minutes
      }

      document.getElementById("claimBtn").onclick = function () {
        if (currentOffer == null) return;

        let data = JSON.parse(localStorage.getItem("cartItems")) || [];

        // ðŸ›‘ Prevent claiming discount again on same cart
        let previousCart = JSON.parse(localStorage.getItem("discountedCart"));
        if (
          previousCart &&
          JSON.stringify(previousCart) === JSON.stringify(data)
        ) {
          alert("You have already used an offer for this cart!");
          return;
        }

        // ðŸ’° Calculate discount
        let total = data.reduce((sum, item) => sum + item.price * item.qty, 0);
        let discountAmount = (total * currentOffer) / 100;
        let finalTotal = Math.floor(total - discountAmount);
        console.log(finalTotal);

        // Save discount data
        localStorage.setItem("discountedTotal", finalTotal);
        localStorage.setItem("discountedCart", JSON.stringify(data));
        localStorage.setItem("offerApplied", currentOffer + "% OFF");

        // Save 30 min claim lock
        localStorage.setItem("offerClaimTime", Date.now());

        updateBillUI();
        notification.style.display = "none";
        currentOffer = null;
      };

      // ---------------------- PAYMENT SELECT BELOW PRODUCTS ----------------------
      const select = document.createElement("div");
      select.innerHTML = `
  <div class="payment-container">
    <div class="payment-select">
      <select>
        <option>Cash On Delivery</option>
        <option>UPI</option>
        <option>Net Banking</option>
        <option>Debit Card</option>
        <option>Credit Card</option>
      </select>
    </div>
    <button class="confirm-btn">Confirm Order</button>
  </div>
`;
      if (data.length === 0) {
        select.style.display = "none";
      }
      document.body.append(select);

      const confirmBtn = select.querySelector(".confirm-btn");
      confirmBtn.onclick = function () {
        let cart = JSON.parse(localStorage.getItem("cartItems")) || [];
        let total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);

        let discountedTotal = localStorage.getItem("discountedTotal") || total;
        let offerApplied = localStorage.getItem("offerApplied") || "No Offer";

        // ---------- BILL DATA OBJECT ----------
        let billData = {
          products: cart,
          offer: offerApplied,
          delivery: "FREE",
          total: total,
          finalAmount: discountedTotal,
        };

        // ---------- SAVE FOR BILL PAGE ----------
        localStorage.setItem("billData", JSON.stringify(billData));

        window.location.href = "deliver.html";
      };

      // ---------------------- OFFER BUTTON ----------------------
      const offerBtn = document.createElement("button");
      offerBtn.classList.add("off");
      offerBtn.innerText = "Check for Offers";
      offerBtn.onclick = showOffer;
      document.body.insertBefore(offerBtn, notification); // place above notification
      if (data.length === 0) {
        offerBtn.style.display = "none";
      }
    </script>
  </body>
</html>
